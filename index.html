<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GyanGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Scrollbar for Mobile/Desktop */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Message Markdown Styles */
        .message-content pre { background: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin: 0.5rem 0; font-size: 0.875rem; }
        .message-content code { font-family: monospace; background: #e2e8f0; padding: 0.15rem 0.3rem; border-radius: 0.25rem; font-size: 0.875em;}
        .dark .message-content code { background: #334155; }
        .message-content pre code { background: transparent; padding: 0; }
        .message-content p { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 h-screen flex overflow-hidden transition-colors duration-200">

    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-transform transform -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full shadow-xl md:shadow-none">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold">Chats</h2>
            <button id="closeSidebarBtn" class="md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-3">
            <button id="newChatBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>
        <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1">
            </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <button id="settingsBtn" class="w-full flex items-center gap-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">
                <i class="fas fa-cog text-lg"></i> Settings & API
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative w-full">
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-20 absolute top-0 w-full">
            <div class="flex items-center gap-4">
                <button id="openSidebarBtn" class="md:hidden text-gray-600 dark:text-gray-300 text-xl">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500">GyanGPT</h1>
            </div>
            <button id="themeToggleBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 sm:p-6 pt-20 pb-28">
            <div id="messages" class="max-w-3xl mx-auto space-y-6">
                <div class="text-center py-16 text-gray-500 dark:text-gray-400" id="welcomeScreen">
                    <i class="fas fa-robot text-6xl mb-6 text-blue-500 animate-bounce"></i>
                    <h2 class="text-2xl font-bold mb-2">How can I help you today?</h2>
                    <p class="text-sm">Click the gear icon in the menu to set up your OpenRouter API.</p>
                </div>
            </div>
        </div>

        <div class="absolute bottom-0 w-full bg-gradient-to-t from-gray-50 via-gray-50 to-transparent dark:from-gray-900 dark:via-gray-900 p-4 pb-6 z-20">
            <div class="max-w-3xl mx-auto relative">
                <form id="chatForm" class="flex items-end gap-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-3xl p-2 pl-4 shadow-xl">
                    <textarea id="userInput" rows="1" class="flex-1 bg-transparent border-0 focus:ring-0 resize-none py-3 max-h-32 text-gray-800 dark:text-gray-100 placeholder-gray-400 outline-none" placeholder="Message AI..."></textarea>
                    <button type="submit" id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 h-12 w-12 flex items-center justify-center transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </form>
                <div class="text-center text-[10px] text-gray-400 mt-2 font-medium tracking-wide uppercase">
                    Powered by OpenRouter API
                </div>
            </div>
        </div>
    </main>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl transform transition-all border border-gray-200 dark:border-gray-700">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-sliders-h text-blue-500"></i> API Settings</h3>
                <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">OpenRouter API Key <span class="text-red-500">*</span></label>
                    <input type="password" id="apiKeyInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-xl p-3 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="sk-or-v1-...">
                    <p class="text-xs text-gray-500 mt-1">Get for free at <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-500 font-bold">openrouter.ai</a></p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Model ID</label>
                    <input type="text" id="modelInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-xl p-3 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" value="google/gemini-2.0-pro-exp-02-05:free">
                    <p class="text-xs text-gray-500 mt-1">Try: <code>deepseek/deepseek-r1:free</code></p>
                </div>
            </div>
            <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3 bg-gray-50 dark:bg-gray-800/50 rounded-b-2xl">
                <button id="cancelSettingsBtn" class="px-5 py-2.5 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition-colors">Cancel</button>
                <button id="saveSettingsBtn" class="px-5 py-2.5 text-sm font-semibold bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors">Save Details</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements setup
        const DOM = {
            sidebar: document.getElementById('sidebar'),
            openSidebarBtn: document.getElementById('openSidebarBtn'),
            closeSidebarBtn: document.getElementById('closeSidebarBtn'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            chatForm: document.getElementById('chatForm'),
            userInput: document.getElementById('userInput'),
            messages: document.getElementById('messages'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            sendBtn: document.getElementById('sendBtn'),
            chatList: document.getElementById('chatList'),
            newChatBtn: document.getElementById('newChatBtn')
        };

        // State Management via LocalStorage
        let state = {
            apiKey: localStorage.getItem('ai_api_key') || '',
            modelName: localStorage.getItem('ai_model') || 'google/gemini-2.0-pro-exp-02-05:free',
            chats: JSON.parse(localStorage.getItem('ai_chats')) || [],
            currentChatId: null
        };

        // UI Interactions
        DOM.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value.trim() === '') this.style.height = 'auto';
        });

        DOM.userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                DOM.chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Mobile Sidebar
        DOM.openSidebarBtn.onclick = () => DOM.sidebar.classList.remove('-translate-x-full');
        DOM.closeSidebarBtn.onclick = () => DOM.sidebar.classList.add('-translate-x-full');

        // Dark Mode Logic
        const toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            DOM.themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        };
        
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            DOM.themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
        }
        DOM.themeToggleBtn.onclick = toggleTheme;

        // Settings Logic
        const toggleSettings = (show) => {
            if (show) {
                document.getElementById('apiKeyInput').value = state.apiKey;
                document.getElementById('modelInput').value = state.modelName;
                DOM.settingsModal.classList.remove('hidden');
            } else {
                DOM.settingsModal.classList.add('hidden');
            }
        };

        DOM.settingsBtn.onclick = () => toggleSettings(true);
        DOM.closeSettingsBtn.onclick = () => toggleSettings(false);
        DOM.cancelSettingsBtn.onclick = () => toggleSettings(false);
        
        DOM.saveSettingsBtn.onclick = () => {
            state.apiKey = document.getElementById('apiKeyInput').value.trim();
            state.modelName = document.getElementById('modelInput').value.trim() || 'google/gemini-2.0-pro-exp-02-05:free';
            localStorage.setItem('ai_api_key', state.apiKey);
            localStorage.setItem('ai_model', state.modelName);
            toggleSettings(false);
        };

        // Chat History Management
        const saveChats = () => localStorage.setItem('ai_chats', JSON.stringify(state.chats));

        const renderChatList = () => {
            DOM.chatList.innerHTML = '';
            state.chats.forEach(chat => {
                const btn = document.createElement('button');
                const isActive = chat.id === state.currentChatId;
                btn.className = `w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${isActive ? 'bg-blue-50 dark:bg-gray-700/80 border border-blue-100 dark:border-gray-600' : ''}`;
                btn.innerHTML = `
                    <i class="far fa-message ${isActive ? 'text-blue-500' : 'text-gray-500'}"></i>
                    <span class="truncate flex-1 text-sm font-medium ${isActive ? 'text-blue-700 dark:text-blue-400' : ''}">${chat.title}</span>
                    <i class="fas fa-trash text-gray-400 hover:text-red-500 p-1 delete-chat"></i>
                `;
                btn.onclick = (e) => { if(!e.target.classList.contains('delete-chat')) loadChat(chat.id); };
                btn.querySelector('.delete-chat').onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                };
                DOM.chatList.appendChild(btn);
            });
        };

        const createNewChat = () => {
            const newChat = { id: Date.now().toString(), title: 'New Conversation', messages: [] };
            state.chats.unshift(newChat);
            saveChats();
            loadChat(newChat.id);
            if (window.innerWidth < 768) DOM.sidebar.classList.add('-translate-x-full');
        };

        const loadChat = (id) => {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            DOM.messages.innerHTML = '';
            
            if (chat.messages.length === 0) {
                DOM.messages.appendChild(DOM.welcomeScreen);
                DOM.welcomeScreen.classList.remove('hidden');
            } else {
                DOM.welcomeScreen.classList.add('hidden');
                chat.messages.forEach(msg => appendMessage(msg.role, msg.content, false));
            }
            renderChatList();
            scrollToBottom();
        };

        const deleteChat = (id) => {
            state.chats = state.chats.filter(c => c.id !== id);
            saveChats();
            if (state.currentChatId === id) {
                if (state.chats.length > 0) loadChat(state.chats[0].id);
                else {
                    state.currentChatId = null;
                    DOM.messages.innerHTML = '';
                    DOM.messages.appendChild(DOM.welcomeScreen);
                    DOM.welcomeScreen.classList.remove('hidden');
                }
            }
            renderChatList();
        };

        DOM.newChatBtn.onclick = createNewChat;

        // Basic Markdown parser
        const parseMarkdown = (text) => {
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        };

        // UI Appending
        const appendMessage = (role, content, animate = true) => {
            DOM.welcomeScreen.classList.add('hidden');
            const div = document.createElement('div');
            div.className = `flex gap-3 sm:gap-4 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shrink-0 shadow-md text-sm sm:text-base"><i class="fas fa-user"></i></div>`
                : `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white shrink-0 shadow-md text-sm sm:text-base"><i class="fas fa-robot"></i></div>`;
            
            const bubbleClass = role === 'user'
                ? 'bg-blue-600 text-white rounded-tr-sm'
                : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 rounded-tl-sm';

            div.innerHTML = `
                ${avatar}
                <div class="max-w-[85%] sm:max-w-[75%] rounded-2xl p-3 sm:p-4 ${bubbleClass} shadow-sm message-content text-sm sm:text-base leading-relaxed">
                    ${role === 'user' ? content.replace(/\n/g, '<br>') : parseMarkdown(content)}
                </div>
            `;
            
            DOM.messages.appendChild(div);
            scrollToBottom();
            
            if (animate) {
                div.style.opacity = '0';
                div.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    div.style.transition = 'all 0.3s ease';
                    div.style.opacity = '1';
                    div.style.transform = 'translateY(0)';
                }, 10);
            }
        };

        const scrollToBottom = () => {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        };

        const toggleTyping = (show) => {
            if (show) {
                const div = document.createElement('div');
                div.id = 'typingIndicator';
                div.className = `flex gap-3 sm:gap-4`;
                div.innerHTML = `
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white shrink-0 shadow-md text-sm"><i class="fas fa-robot"></i></div>
                    <div class="max-w-[80%] rounded-2xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm flex items-center gap-1.5 rounded-tl-sm">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                `;
                DOM.messages.appendChild(div);
                scrollToBottom();
            } else {
                const ind = document.getElementById('typingIndicator');
                if (ind) ind.remove();
            }
        };

        // API Submission logic
        DOM.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = DOM.userInput.value.trim();
            if (!text) return;
            
            if (!state.apiKey) {
                alert('⚠️ OpenRouter API Key is missing!\nPlease enter it in Settings to start chatting.');
                toggleSettings(true);
                return;
            }

            if (!state.currentChatId) createNewChat();

            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            
            // Name the chat after the first message
            if (chat.messages.length === 1) {
                chat.title = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                renderChatList();
            }
            
            saveChats();
            appendMessage('user', text);
            DOM.userInput.value = '';
            DOM.userInput.style.height = 'auto';
            DOM.sendBtn.disabled = true;

            toggleTyping(true);

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Universal AI HTML App',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: state.modelName,
                        messages: chat.messages
                    })
                });

                toggleTyping(false);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API Connection Failed');
                }

                const data = await response.json();
                const reply = data.choices[0].message.content;

                chat.messages.push({ role: 'assistant', content: reply });
                saveChats();
                appendMessage('assistant', reply);

            } catch (error) {
                toggleTyping(false);
                appendMessage('assistant', `**Connection Error:** ${error.message}\n\n*Fix:* Check your API key in settings or try changing the Model ID (e.g. \`deepseek/deepseek-r1:free\`).`);
            } finally {
                DOM.sendBtn.disabled = false;
                DOM.userInput.focus();
            }
        });

        // App Init
        if (state.chats.length > 0) loadChat(state.chats[0].id);
        else renderChatList();
        
        // Suggest API setup on first load
        if (!state.apiKey) setTimeout(() => toggleSettings(true), 1500);

    </script>
</body>
</html>
